---
{"dg-publish":true,"permalink":"/技術文件/C 語言學習/野指針/","tags":["C-lang"],"created":"2025-08-18T21:56:22.336+08:00","updated":"2025-12-18T00:21:16.419+08:00"}
---


![Pasted image 20250818215631.png](/img/user/images/Pasted%20image%2020250818215631.png)

``` C
// 野指針
#include <stdio.h>
int main(){
    int *p;
    printf("%p\n", &p);
    return  0;
}

// execute: clang PointerTest-3.2.c -o PointerTest-3.2 && ./PointerTest-3.2
```


修改未初始化的指針變數的值
``` C
// 野指針
#include <stdio.h>
int main(){
    int *p;
    *p = 10; // 在沒有初始化指針變數的情況下，修改指針變數的值是錯誤的
    printf("%p\n", &p); // 引發: Bus error: 10
    return  0;
}

// execute: clang PointerTest-3.2.c -o PointerTest-3.2 && ./PointerTest-3.2
```

``` C
// 野指針
#include <stdio.h>
int main(){
    int num = 11;
    int *p;
    *p = num; // 在沒有初始化指針變數的情況下，修改指針變數的值是錯誤的
    printf("%p\n", &p); // 引發: Bus error: 10
    printf("%d\n", *p);
    return  0;
}

// execute: clang PointerTest-3.2.c -o PointerTest-3.2 && ./PointerTest-3.2
```

## `Bus error: 10` 
是在 **Unix-like 系統（像 macOS、Linux）** 上常見的錯誤訊息。代表程式嘗試存取 **無效的記憶體位址** 或 **不符合對齊規則的記憶體位址**。

在 macOS 上特別常見，因為它的記憶體對齊要求比較嚴格。
### 原因
1. **指標錯誤使用**
    - 指標指向無效的記憶體位置（例如已經 `free` 過，或是從未正確初始化）。
    - 指標運算錯誤，導致存取到錯誤位置。 
# 指針越界訪問
![Pasted image 20250818222350.png](/img/user/images/Pasted%20image%2020250818222350.png)

``` C
// 野指針
#include <stdio.h>
int main(){
    int arr[5] = {1, 3, 5, 7, 9}; 
    printf("%d\n", arr[1]); // 3
    printf("%p\n", &arr[1]); // 0x16bc9eab4
    printf("%d\n", arr[2]); // 5
    printf("%p\n", &arr[2]); // 0x16bc9eab8
    printf("%d\n", arr[99]); // 0 <- 野指針，無法預測這裡的值
    printf("%p\n", &arr[99]); // 0x16bc9ec3c <- 野指針地址，無法預測這裡的值
}

// execute: clang PointerTest-3.2.c -o PointerTest-3.2 && ./PointerTest-3.2
```

野指針 2:
以 for loop 方式越界訪問
``` C
// 野指針
#include <stdio.h>
int main(){
    int arr[5] = {1, 3, 5, 7, 9}; 
    for (int i = 0; i < 10; i++){
        printf("index: %d, value: %d\n", i, arr[i]);
    }
}

// execute: clang PointerTest-3.2.c -o PointerTest-3.2 && ./PointerTest-3.2

/* 
output:
index: 0, value: 1
index: 1, value: 3
index: 2, value: 5
index: 3, value: 7
index: 4, value: 9
index: 5, value: 1
index: 6, value: -1657536328
index: 7, value: -1157789503
index: 8, value: 1836167456
index: 9, value: 1
*/
```


``` C
// 野指針
#include <stdio.h>
int main(){
    int arr[5] = {1, 3, 5, 7, 9}; 
    int *p = arr; // 賦值 &arr[0]
    for (int i = 0; i < 10; i++){
        printf("%d\n", *p++); // 地址先 +1 個 int 單位(4 個 bytes = 32 bits)
    }
}

// execute: clang PointerTest-3.2.c -o PointerTest-3.2 && ./PointerTest-3.2
/*
output:
1
3
5
7
9
1
525336608
-509251205
1865920800
1
*/
```

訪問已回收的地址
``` C
// 野指針
#include <stdio.h>
int *test(){
    int a = 15; // 局部變數
    // 返回變數 a 的地址
    return &a;
}

void dummy_function(){
    int x = 999, y = 888, z = 777; // 故意覆蓋 stack
    printf("dummy function called\n");
}

int main(){
	// 因為 p2 指向一個可能會被回收掉的地址，所以就產生一個野指針
    int *p2 = test();
    printf("第一次讀取: %d\n", *p2);
    
    dummy_function(); // 覆蓋 stack
    
    printf("第二次讀取: %d\n", *p2); // 讀到垃圾值
    return 0;
}

// execute: clang PointerTest-3.2.c -o PointerTest-3.2 && ./PointerTest-3.2

/*
output:
	第一次讀取: 15
	dummy function called
	第二次讀取: 1
*/
```

# 避免野指針
![Pasted image 20250818231729.png](/img/user/images/Pasted%20image%2020250818231729.png)


![Pasted image 20250819212325.png](/img/user/images/Pasted%20image%2020250819212325.png)